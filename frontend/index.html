<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全息拉普拉斯互联网爬虫系统</title>
    <!-- 基础样式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- 自定义样式 - 修正路径 -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/backgrounds.css">
    <link rel="stylesheet" href="css/theme-styles.css">
    <!-- 图表支持 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- 提示框支持 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="theme-default content-opacity-100">
    <!-- 新增：背景遮罩层，改善背景与内容的对比 -->
    <div id="background-overlay"></div>
    
    <div class="container-fluid">
        <header class="py-3 mb-4 border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h1>全息拉普拉斯互联网爬虫系统</h1>
                <div class="d-flex align-items-center">
                    <!-- 语言切换器 -->
                    <div class="dropdown me-2">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-globe"></i> 语言
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                            <li><a class="dropdown-item active" href="#" data-lang="zh">中文</a></li>
                            <li><a class="dropdown-item" href="#" data-lang="en">English</a></li>
                        </ul>
                    </div>
                    
                    <!-- 设置菜单 -->
                    <div class="dropdown me-2">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="settingsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-gear"></i> 设置
                        </button>
                        <div class="dropdown-menu dropdown-menu-end settings-dropdown p-3" style="width: 280px;">
                            <!-- 主题设置 -->
                            <h6 class="dropdown-header">主题</h6>
                            <div class="mb-3">
                                <select id="theme-selector" class="form-select form-select-sm">
                                    <option value="theme-default">默认主题</option>
                                    <option value="theme-dark">深色主题</option>
                                    <option value="theme-blue">蓝色主题</option>
                                    <option value="theme-purple">紫色主题</option>
                                    <option value="theme-green">绿色主题</option>
                                </select>
                            </div>
                            
                            <!-- 背景设置 -->
                            <h6 class="dropdown-header">背景</h6>
                            <div class="background-options compact mb-3">
                                <div class="bg-option active" data-bg="bg-image-none" title="无背景">
                                    <i class="bi bi-x-lg"></i>
                                </div>
                                <div class="bg-option" data-bg="bg-image-anime1" title="动漫1">
                                </div>
                                <div class="bg-option" data-bg="bg-image-anime2" title="动漫2">
                                </div>
                                <div class="bg-option" data-bg="bg-image-abstract" title="抽象">
                                </div>
                                <div class="bg-option" data-bg="bg-image-tech" title="科技">
                                </div>
                                <div class="bg-option" data-bg="bg-image-custom" title="自定义" id="custom-bg-option">
                                    <i class="bi bi-upload"></i>
                                </div>
                            </div>
                            <label for="custom-bg-upload" class="btn btn-sm btn-outline-secondary w-100 mb-3">
                                <i class="bi bi-upload"></i> 上传自定义背景
                            </label>
                            <input type="file" id="custom-bg-upload" style="display: none;" accept="image/*">
                            
                            <!-- 透明度设置 -->
                            <h6 class="dropdown-header">内容透明度</h6>
                            <div class="opacity-options mb-3">
                                <div class="opacity-option active" data-opacity="content-opacity-100" title="100%">
                                    100
                                </div>
                                <div class="opacity-option" data-opacity="content-opacity-90" title="90%">
                                    90
                                </div>
                                <div class="opacity-option" data-opacity="content-opacity-80" title="80%">
                                    80
                                </div>
                                <div class="opacity-option" data-opacity="content-opacity-70" title="70%">
                                    70
                                </div>
                            </div>
                            
                            <!-- 毛玻璃效果 -->
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="glass-effect-toggle">
                                <label class="form-check-label" for="glass-effect-toggle">
                                    启用毛玻璃效果
                                </label>
                            </div>
                            
                            <!-- 广告设置 -->
                            <h6 class="dropdown-header mt-3">界面元素</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggle-assistant">
                                <label class="form-check-label" for="toggle-assistant">显示小助手</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggle-announcements">
                                <label class="form-check-label" for="toggle-announcements">显示公告</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggle-recommendations">
                                <label class="form-check-label" for="toggle-recommendations">显示推荐</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 服务器状态指示器 -->
                    <span id="server-status-text" class="me-2">服务器状态:</span>
                    <div id="serverStatusIndicator" class="status-indicator bg-secondary" title="正在检查服务器状态..."></div>
                </div>
            </div>
        </header>

        <main>
            <div class="row">
                <!-- 左侧配置面板 -->
                <div class="col-lg-3 mb-4">
                    <div class="accordion" id="configAccordion">
                        <!-- 爬虫配置 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConfig" aria-expanded="true">
                                    <i class="bi bi-gear-fill me-2"></i> 爬虫配置
                                </button>
                            </h2>
                            <div id="collapseConfig" class="accordion-collapse collapse show" data-bs-parent="#configAccordion">
                                <div class="accordion-body">
                                    <form id="crawlerForm">
                                        <div class="mb-3">
                                            <label for="urlInput" class="form-label">URL列表</label>
                                            <textarea id="urlInput" class="form-control" rows="6" placeholder="输入URL，每行一个，例如: https://example.com"></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="crawlDepth" class="form-label">爬取深度</label>
                                            <select id="crawlDepth" class="form-select">
                                                <option value="1">1级 (只爬取输入页面)</option>
                                                <option value="2" selected>2级 (包含链接页面)</option>
                                                <option value="3">3级 (包含二级链接)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label id="storage-format-label" class="form-label">存储格式</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="storageFormat" id="formatTxt" value="txt">
                                                <label class="form-check-label" for="formatTxt">TXT 格式</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="storageFormat" id="formatHtml" value="html" checked>
                                                <label class="form-check-label" for="formatHtml">HTML 格式</label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="concurrency" class="form-label">并发数</label>
                                            <select id="concurrency" class="form-select">
                                                <option value="1">1 (低)</option>
                                                <option value="3" selected>3 (中)</option>
                                                <option value="5">5 (高)</option>
                                            </select>
                                        </div>
                                        
                                        <div class="d-grid gap-2">
                                            <button type="button" id="runBtn" class="btn btn-primary">运行爬虫</button>
                                            <button type="button" id="generateBtn" class="btn btn-outline-primary">生成配置文件</button>
                                            <a id="downloadLink" class="btn btn-success d-none" download="crawler_config.json">下载配置文件</a>
                                            <button type="button" id="clearBtn" class="btn btn-secondary">清除输入</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 使用说明 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGuide" aria-expanded="false">
                                    <i class="bi bi-question-circle-fill me-2"></i> 使用说明
                                </button>
                            </h2>
                            <div id="collapseGuide" class="accordion-collapse collapse" data-bs-parent="#configAccordion">
                                <div class="accordion-body">
                                    <ol id="user-guide" class="small">
                                        <li>在URL列表中输入要爬取的网站地址</li>
                                        <li>设置爬取深度和存储格式</li>
                                        <li>点击"运行爬虫"直接开始爬取</li>
                                        <li>或者点击"生成配置文件"并下载</li>
                                        <li>查看"任务列表"标签页跟踪任务进度</li>
                                        <li>爬取完成后，可在结果标签页查看分析</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 附加功能区域 - 默认隐藏 -->
                    <div id="sidebarExtras" class="mt-4">
                        <!-- 小助手区域 - 默认隐藏 -->
                        <div id="assistantSection" class="sidebar-section mb-4 d-none">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="bi bi-person-hearts"></i> 小助手</h5>
                                    <button type="button" class="btn-close" aria-label="Close" 
                                            onclick="document.getElementById('assistantSection').classList.add('d-none');document.getElementById('toggle-assistant').checked=false;"></button>
                                </div>
                                <div class="card-body text-center">
                                    <div id="live2d-widget" class="live2d-widget-container"></div>
                                    <p class="text-center mt-2">我是你的爬虫助手！有任何问题可以问我哦~</p>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary change-model-btn">
                                            <i class="bi bi-arrow-repeat"></i> 换装
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary toggle-dialog-btn">
                                            <i class="bi bi-chat-dots"></i> 对话
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 公告区域 - 默认隐藏 -->
                        <div id="announcementSection" class="sidebar-section mb-4 d-none">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="bi bi-megaphone"></i> 公告</h5>
                                    <button type="button" class="btn-close" aria-label="Close"
                                            onclick="document.getElementById('announcementSection').classList.add('d-none');document.getElementById('toggle-announcements').checked=false;"></button>
                                </div>
                                <div class="card-body">
                                    <p><strong>新版本发布!</strong> 全息拉普拉斯互联网爬虫系统3.0现已推出</p>
                                    <p>新功能包括更强大的阴谋论检测算法和多语言支持。</p>
                                    <a href="#" class="btn btn-sm btn-primary">了解更多</a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 推荐阅读区域 - 默认隐藏 -->
                        <div id="recommendationSection" class="sidebar-section mb-4 d-none">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="bi bi-book"></i> 推荐阅读</h5>
                                    <button type="button" class="btn-close" aria-label="Close"
                                            onclick="document.getElementById('recommendationSection').classList.add('d-none');document.getElementById('toggle-recommendations').checked=false;"></button>
                                </div>
                                <div class="card-body">
                                    <p>《全息拉普拉斯理论与互联网拓扑分析》</p>
                                    <p class="small text-muted">探索互联网节点关系的前沿研究方法</p>
                                    <a href="#" class="btn btn-sm btn-outline-primary">查看详情</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 中央内容展示面板 -->
                <div class="col-lg-9">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="resultTabs">
                                <li class="nav-item">
                                    <a class="nav-link active" id="upload-tab" data-bs-toggle="tab" href="#upload">上传结果</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="tasks-tab" data-bs-toggle="tab" href="#tasks">任务列表</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="content-tab" data-bs-toggle="tab" href="#content">抓取内容</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="category-tab" data-bs-toggle="tab" href="#category">分类结果</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="conspiracy-tab" data-bs-toggle="tab" href="#conspiracy">阴谋论检测</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="stats-tab" data-bs-toggle="tab" href="#stats">统计信息</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content">
                                <!-- 上传结果标签页 -->
                                <div class="tab-pane fade show active" id="upload">
                                    <div class="text-center py-5">
                                        <h5 class="mb-4">上传爬虫结果文件</h5>
                                        <div class="upload-area mb-4" id="uploadArea">
                                            <div class="upload-icon">
                                                <i class="bi bi-cloud-arrow-up fs-1"></i>
                                            </div>
                                            <p>拖放结果文件到此处或点击选择文件</p>
                                            <input type="file" id="resultFile" class="d-none" accept=".json">
                                        </div>
                                        <button id="browseBtn" class="btn btn-outline-primary">选择文件</button>
                                    </div>
                                </div>
                                
                                <!-- 任务列表标签页 -->
                                <div class="tab-pane fade" id="tasks">
                                    <div id="taskList">
                                        <div class="text-center py-5">
                                            <p class="text-muted">加载任务列表中...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 抓取内容标签页 -->
                                <div class="tab-pane fade" id="content">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="list-group" id="urlList">
                                                <div class="empty-message text-center py-5">
                                                    <p class="text-muted">请先上传爬虫结果文件或运行爬虫任务</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div id="contentPreview">
                                                <div class="empty-message text-center py-5">
                                                    <p class="text-muted">选择左侧链接查看内容</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 分类结果标签页 -->
                                <div class="tab-pane fade" id="category">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="list-group" id="categoryList">
                                                <div class="empty-message text-center py-5">
                                                    <p class="text-muted">请先上传爬虫结果文件或运行爬虫任务</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-9">
                                            <div id="categoryContent">
                                                <div class="empty-message text-center py-5">
                                                    <p class="text-muted">选择左侧分类查看内容</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 阴谋论检测标签页 -->
                                <div class="tab-pane fade" id="conspiracy">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="list-group" id="conspiracyList">
                                                <div class="empty-message text-center py-5">
                                                    <p class="text-muted">请先上传爬虫结果文件或运行爬虫任务</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-9">
                                            <div id="conspiracyContent">
                                                <div class="empty-message text-center py-5">
                                                    <p class="text-muted">选择左侧项目查看检测结果</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 统计信息标签页 -->
                                <div class="tab-pane fade" id="stats">
                                    <div id="statisticsContent">
                                        <div class="empty-message text-center py-5">
                                            <p class="text-muted">请先上传爬虫结果文件或运行爬虫任务</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="py-3 my-4 border-top">
            <div class="text-center">
                <span class="text-muted">全息拉普拉斯互联网爬虫系统 ©; 2023-2025</span>
            </div>
        </footer>
    </div>

    <!-- 基础脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="api_client.js"></script>
    <script src="script.js"></script>
    
    <!-- 改进的背景管理内联脚本 -->
    <script>
        // 改进的背景管理器实现
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM已加载完成，初始化背景管理器...");
            
            // 初始化背景选项
            initBackgroundOptions();
            
            // 初始化透明度选项
            initOpacityOptions();
            
            // 初始化毛玻璃效果
            initGlassEffect();
            
            // 初始化自定义背景上传
            initCustomBackgroundUpload();
            
            // 从本地存储加载设置
            loadBackgroundSettings();
            
            // ===== 背景选项功能 =====
            function initBackgroundOptions() {
                const bgOptions = document.querySelectorAll('.bg-option');
                console.log(`找到 ${bgOptions.length} 个背景选项`);
                
                bgOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        const bgClass = this.getAttribute('data-bg');
                        console.log(`点击背景选项: ${bgClass}`);
                        
                        // 更新选项状态
                        bgOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 设置背景
                        setBodyBackground(bgClass);
                        
                        // 保存设置
                        saveSettings();
                    });
                });
            }
            
            // ===== 透明度选项功能 =====
            function initOpacityOptions() {
                const opacityOptions = document.querySelectorAll('.opacity-option');
                console.log(`找到 ${opacityOptions.length} 个透明度选项`);
                
                opacityOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        const opacityClass = this.getAttribute('data-opacity');
                        console.log(`点击透明度选项: ${opacityClass}`);
                        
                        // 更新选项状态
                        opacityOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 设置透明度
                        document.body.classList.remove('content-opacity-100', 'content-opacity-90', 'content-opacity-80', 'content-opacity-70');
                        document.body.classList.add(opacityClass);
                        
                        // 保存设置
                        saveSettings();
                    });
                });
            }
            
            // ===== 毛玻璃效果功能 =====
            function initGlassEffect() {
                const glassToggle = document.getElementById('glass-effect-toggle');
                if (glassToggle) {
                    glassToggle.addEventListener('change', function() {
                        console.log(`毛玻璃效果切换: ${this.checked}`);
                        
                        if (this.checked) {
                            document.body.classList.add('glass-effect');
                        } else {
                            document.body.classList.remove('glass-effect');
                        }
                        
                        // 保存设置
                        saveSettings();
                    });
                }
            }
            
            // ===== 自定义背景上传功能 =====
            function initCustomBackgroundUpload() {
                const fileInput = document.getElementById('custom-bg-upload');
                if (!fileInput) {
                    console.error("找不到自定义背景上传元素!");
                    return;
                }
                
                console.log("找到自定义背景上传元素，添加事件监听器");
                
                fileInput.addEventListener('change', function(e) {
                    console.log("文件选择事件触发");
                    
                    if (!this.files || !this.files[0]) {
                        console.log("没有选择文件");
                        return;
                    }
                    
                    const file = this.files[0];
                    console.log(`选择了文件: ${file.name}, 类型: ${file.type}, 大小: ${file.size} 字节`);
                    
                    if (!file.type.match('image.*')) {
                        alert('请选择图片文件!');
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imageUrl = e.target.result;
                        console.log(`文件已读取，数据URL长度: ${imageUrl.length}`);
                        
                        // 直接设置背景图片
                        document.body.style.backgroundImage = `url("${imageUrl}")`;
                        
                        // 移除其他背景类并添加自定义背景类
                        document.body.classList.remove(
                            'bg-image-none',
                            'bg-image-anime1',
                            'bg-image-anime2',
                            'bg-image-abstract',
                            'bg-image-tech'
                        );
                        document.body.classList.add('bg-image-custom');
                        
                        // 更新背景选项的激活状态
                        const bgOptions = document.querySelectorAll('.bg-option');
                        bgOptions.forEach(opt => opt.classList.remove('active'));
                        
                        const customOption = document.querySelector('.bg-option[data-bg="bg-image-custom"]');
                        if (customOption) {
                            customOption.classList.add('active');
                        }
                        
                        // 保存自定义背景到本地存储
                        try {
                            localStorage.setItem('customBackground', imageUrl);
                            console.log("自定义背景已保存到本地存储");
                            
                            // 保存设置
                            saveSettings();
                        } catch (error) {
                            console.error("保存背景到本地存储失败:", error);
                            alert("图片太大，无法保存到本地存储。请选择较小的图片。");
                        }
                    };
                    
                    reader.onerror = function() {
                        console.error("读取文件时发生错误");
                        alert("无法读取图片文件，请尝试其他图片。");
                    };
                    
                    console.log("开始读取文件...");
                    reader.readAsDataURL(file);
                });
            }
            
            // ===== 功能函数 =====
            function setBodyBackground(bgClass) {
                console.log(`设置背景: ${bgClass}`);
                
                // 移除所有背景类
                document.body.classList.remove(
                    'bg-image-none',
                    'bg-image-anime1',
                    'bg-image-anime2',
                    'bg-image-abstract',
                    'bg-image-tech',
                    'bg-image-custom'
                );
                
                // 清除自定义背景图片样式，除非选择的是自定义背景
               if (bgClass !== 'bg-image-custom') {
                   document.body.style.backgroundImage = '';
               } else {
                   // 如果是自定义背景，从本地存储中加载
                   const customBg = localStorage.getItem('customBackground');
                   if (customBg) {
                       document.body.style.backgroundImage = `url("${customBg}")`;
                   }
               }
               
               // 添加选择的背景类
               document.body.classList.add(bgClass);
           }
           
           // 保存设置到本地存储
           function saveSettings() {
               console.log("保存背景设置到本地存储");
               
               const settings = {
                   background: Array.from(document.body.classList).find(c => c.startsWith('bg-image-')) || 'bg-image-none',
                   opacity: Array.from(document.body.classList).find(c => c.startsWith('content-opacity-')) || 'content-opacity-100',
                   glassEffect: document.body.classList.contains('glass-effect')
               };
               
               localStorage.setItem('backgroundSettings', JSON.stringify(settings));
               console.log("设置已保存:", settings);
           }
           
           // 从本地存储加载设置
           function loadBackgroundSettings() {
               console.log("尝试从本地存储加载背景设置");
               
               try {
                   const settings = JSON.parse(localStorage.getItem('backgroundSettings') || '{}');
                   console.log("加载的设置:", settings);
                   
                   // 应用背景
                   if (settings.background) {
                       setBodyBackground(settings.background);
                       
                       // 更新背景选项状态
                       document.querySelectorAll('.bg-option').forEach(opt => {
                           if (opt.getAttribute('data-bg') === settings.background) {
                               opt.classList.add('active');
                           } else {
                               opt.classList.remove('active');
                           }
                       });
                   }
                   
                   // 应用透明度
                   if (settings.opacity) {
                       document.body.classList.remove('content-opacity-100', 'content-opacity-90', 'content-opacity-80', 'content-opacity-70');
                       document.body.classList.add(settings.opacity);
                       
                       // 更新透明度选项状态
                       document.querySelectorAll('.opacity-option').forEach(opt => {
                           if (opt.getAttribute('data-opacity') === settings.opacity) {
                               opt.classList.add('active');
                           } else {
                               opt.classList.remove('active');
                           }
                       });
                   }
                   
                   // 应用毛玻璃效果
                   const glassToggle = document.getElementById('glass-effect-toggle');
                   if (settings.glassEffect) {
                       document.body.classList.add('glass-effect');
                       if (glassToggle) glassToggle.checked = true;
                   } else {
                       document.body.classList.remove('glass-effect');
                       if (glassToggle) glassToggle.checked = false;
                   }
               } catch (error) {
                   console.error("加载背景设置失败:", error);
                   // 应用默认设置
                   setBodyBackground('bg-image-none');
               }
           }
       });
   </script>
   
   <!-- 管理侧边栏显示隐藏的脚本 -->
   <script>
       document.addEventListener('DOMContentLoaded', function() {
           // 初始化设置
           const toggleAssistant = document.getElementById('toggle-assistant');
           const toggleAnnouncements = document.getElementById('toggle-announcements');
           const toggleRecommendations = document.getElementById('toggle-recommendations');
           
           // 附加功能区域
           const assistantSection = document.getElementById('assistantSection');
           const announcementSection = document.getElementById('announcementSection');
           const recommendationSection = document.getElementById('recommendationSection');
           const sidebarExtras = document.getElementById('sidebarExtras');
           
           // 更新界面元素显示状态
           function updateExtrasVisibility() {
               const hasVisibleExtras = !assistantSection.classList.contains('d-none') || 
                                        !announcementSection.classList.contains('d-none') || 
                                        !recommendationSection.classList.contains('d-none');
                                        
               if (hasVisibleExtras) {
                   sidebarExtras.classList.remove('d-none');
               } else {
                   sidebarExtras.classList.add('d-none');
               }
           }
           
           // 绑定事件
           if (toggleAssistant) {
               toggleAssistant.addEventListener('change', function() {
                   if (this.checked) {
                       assistantSection.classList.remove('d-none');
                   } else {
                       assistantSection.classList.add('d-none');
                   }
                   updateExtrasVisibility();
               });
           }
           
           if (toggleAnnouncements) {
               toggleAnnouncements.addEventListener('change', function() {
                   if (this.checked) {
                       announcementSection.classList.remove('d-none');
                   } else {
                       announcementSection.classList.add('d-none');
                   }
                   updateExtrasVisibility();
               });
           }
           
           if (toggleRecommendations) {
               toggleRecommendations.addEventListener('change', function() {
                   if (this.checked) {
                       recommendationSection.classList.remove('d-none');
                   } else {
                       recommendationSection.classList.add('d-none');
                   }
                   updateExtrasVisibility();
               });
           }
           
           // 默认状态
           updateExtrasVisibility();
           
           // 语言切换功能
           const langLinks = document.querySelectorAll('.dropdown-item[data-lang]');
           langLinks.forEach(link => {
               link.addEventListener('click', function(e) {
                   e.preventDefault();
                   const lang = this.getAttribute('data-lang');
                   // 实现语言切换逻辑
                   console.log('Language changed to:', lang);
                   
                   // 更新选中状态
                   langLinks.forEach(item => item.classList.remove('active'));
                   this.classList.add('active');
                   
                   // 可以触发语言切换事件
                   const event = new CustomEvent('languageChanged', { detail: { language: lang } });
                   document.dispatchEvent(event);
               });
           });
       });
   </script>
   
   <!-- 主题切换按钮事件处理 -->
   <script>
       document.addEventListener('DOMContentLoaded', function() {
           const themeSelector = document.getElementById('theme-selector');
           if (themeSelector) {
               // 加载保存的主题
               const savedTheme = localStorage.getItem('theme') || 'theme-default';
               themeSelector.value = savedTheme;
               document.body.className = document.body.className.replace(/theme-\w+/, savedTheme);
               
               // 主题切换事件
               themeSelector.addEventListener('change', function() {
                   const newTheme = this.value;
                   console.log(`切换主题: ${newTheme}`);
                   
                   // 移除所有主题类
                   document.body.classList.remove('theme-default', 'theme-dark', 'theme-blue', 'theme-purple', 'theme-green');
                   
                   // 添加新主题类
                   document.body.classList.add(newTheme);
                   
                   // 保存到本地存储
                   localStorage.setItem('theme', newTheme);
                   
                   // 触发主题变更事件
                   document.dispatchEvent(new CustomEvent('themeChanged', { detail: { theme: newTheme } }));
               });
           }
       });
   </script>
   
   <!-- 添加的 background-manager.js 引用 -->
   <script src="js/background-manager.js"></script>
   
   <!-- 添加的 theme-switcher.js 引用 -->
   <script src="js/theme-switcher.js"></script>
   
   <!-- 剩余脚本 -->
   <script src="language-manager.js"></script>
   <script src="ui-manager.js"></script>
</body>
</html>